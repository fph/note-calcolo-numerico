name: Build LaTeX document
on: [push]
jobs:
  build_latex:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    concurrency:
      group: release-latex
      cancel-in-progress: true
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v4
      - name: Compile LaTeX document with jobname=notes
        uses: xu-cheng/latex-action@v4
        with:
          root_file: notes.tex
          compiler: pdflatex
          args: -jobname=notes
      - name: Compile LaTeX document with jobname=notes-ich
        uses: xu-cheng/latex-action@v4
        with:
          root_file: notes.tex
          compiler: pdflatex
          args: -jobname=notes-ich
      - name: Compile LaTeX document with jobname=notes-inf
        uses: xu-cheng/latex-action@v4
        with:
          root_file: notes.tex
          compiler: pdflatex
          args: -jobname=notes-inf
      - name: Verify all PDF files exist
        run: |
          test -f notes.pdf
          test -f notes-ich.pdf
          test -f notes-inf.pdf
      - name: Release PDFs as named tag release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            notes.pdf
            notes-ich.pdf
            notes-inf.pdf
      - name: Delete existing 'latest' release (if any)
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: "latest"
              });

              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id
              });
            } catch (e) {
              console.log("No existing 'latest' release found");
            }
      - name: Release PDFs as 'latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: latest
          files: |
            notes.pdf
            notes-ich.pdf
            notes-inf.pdf
